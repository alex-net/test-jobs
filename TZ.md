# Тестовое задание "банк"

Необходимо реализовать работу со следующими сущностями:
    1. Пользователь
    1. Администратор
    1. Счет - имеет баланс, привязан к пользователю
    1. Платеж(пополнение баланса) - хранит уникальный идентификатор и сумму пополнения счета пользователя

Пользователь должен иметь следующие возможности:
    1. Авторизоваться по email/password
    1. Получить данные о себе(id, email, full_name)
    1. Получить список своих счетов и балансов
    1. Получить список своих платежей

Администратор должен иметь следующие возможности:
    1. Авторизоваться по email/password
    1. Получить данные о себе (id, email, full_name)
    1. Создать/Удалить/Обновить пользователя
    1. Получить список пользователей и список его счетов с балансами

Для работы с платежами должен быть реализован роут эмулирующий обработку вебхука от сторонней платежной системы.
Структура json-объекта для обработки вебхука должна состоять из следующих полей:
    - **transaction_id** - уникальный идентификатор транзакции в “сторонней системе”
    - **account_id** - уникальный идентификатор счета пользователя
    - **user_id** - уникальный идентификатор счета пользователя
    - **amount** - сумма пополнения счета пользователя
    - **signature** - подпись объекта

**signature** должна формироваться через **SHA256** хеш, для строки состоящей из конкатенации значений объекта в алфавитном порядке ключей и “секретного ключа” хранящегося в конфигурации проекта (**{account_id}{amount}{transaction_id}{user_id}{secret_key}**).

Пример, для secret_key **gfdmhghif38yrf9ew0jkf32**:
```
{
  "transaction_id": "5eae174f-7cd0-472c-bd36-35660f00132b",
  "user_id": 1,
  "account_id": 1,
  "amount": 100,
  "signature": "7b47e41efe564a062029da3367bde8844bea0fb049f894687cee5d57f2858bc8"
}
```

При обработке вебхука необходимо:
    1. Проверить подпись объекта
    1. Проверить существует ли у пользователя такой счет - если нет, его необходимо создать
    1. Сохранить транзакцию в базе данных
    1. Начислить сумму транзакции на счет пользователя

Транзакции являются уникальными, начисление суммы с одним transaction_id должно производиться только один раз.

Для тестирования приложения в миграции должен быть создан:
    1. Тестовый пользователь
    1. Счет тестового пользователя
    1. Тестовый администратор

Для развертывания проекта необходимо реализовать docker compose конфигурацию состоящую из сервиса postgresql и сервиса приложения.

---

## Доступы

Логигн: __admin@any-bank.ru__
<br>Пароль: __admin-pass__

Логигн: __user@any-bank.ru__
<br>Пароль: __user-pass__

---

## Инструкция по запуску

* Склонировать репозитарий при помощи `git clone` на рабочий компьютер
* Перейти в терминале в корень скачанного репозитария
* Скопировать файл *.env.example* в *.env* и произвести правильное его заполнение согласно оставленным внутри файла коментариям
* Запустить приложение при помощи `docker compose up -d`
* Зайти в контейнер *php* при помощи команды `docker compose exec -ti php sh`
* Выполнить установку компанентов приложения при помощи команды `composer i`
* Применить миграции к базе данных при помощи команды `./yii migrate`

## Заполнение счетов пльзователей

Для этих целий в приложении предусмотрены 2 технологических пути. [Первый](/external-payment-system) служит для генерации данных одной транзакции по выбранному случайным образом пользователю. [Второй](/payment-data-processing) является обработчким транзакций - заносит данные транзакции в базу прилежения. посредником между ними выступает консольная команда `./yii payment-process N `, где *N* - число запросов транзакций (поумолчанию = 1). Как пользоваться:
* Зайти в контейнер *php* при помощи команды `docker compose exec -ti php sh`
* выполнить команду `./yii payment-process ` или `./yii payment-process 1` для генерации и последующей обработки одной транзакции либо `./yii payment-process 1` для генерации 15и транзакций.

Список счетов доступен в [профиле](/profile) пользователя. Там же будут ссылки для просмотра детализации счетов. Админ может видеть только список счетов любого пользователя. Детализации счетов других пользователей админ видеть не может.
